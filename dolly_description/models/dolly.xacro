<?xml version="1.0" ?>
<robot name="dolly" xmlns:xacro="http://www.ros.org/wiki/xacro">

  <xacro:arg name="sim_gazebo_classic" default="$(optenv SIM_GAZEBO_CLASSIC)" />
  <xacro:arg name="sim_ignition" default="$(optenv SIM_IGNITION)" />

  <link name="chassis">
    <inertial>
      <mass value="1"/>
      <origin rpy="0 0 0" xyz="0 0 0."/>
      <inertia ixx="0.0277" ixy="0" ixz="0" iyy="0.0852" iyz="0" izz="0.1041"/>
    </inertial>
    <visual>
      <geometry>
          <box size="1.0 0.5 0.15"/>
      </geometry>
      <material name='chassis_material'>
        <script>
          <uri>model://dolly/materials/scripts</uri>
          <uri>model://dolly/materials/textures</uri>
          <name>Dolly/fur</name>
        </script>
      </material>
    </visual>
  </link>

  <link name="box">
    <inertial>
      <mass value="0"/>
      <origin rpy="0 0 0" xyz="0 0 0."/>
      <inertia ixx="0" ixy="0" ixz="0" iyy="0" iyz="0" izz="0"/>
    </inertial>
    <visual name="box">
      <pose>0 0 0.08 0 0 0.24</pose>
      <geometry>
          <mesh filename="model://cardboard_box/meshes/cardboard_box.dae" scale="1.25931896 1.007455168 0.755591376" />
      </geometry>
    </visual>
  </link>

  <joint name='box_joint' type='fixed'>
    <origin xyz="0 0 0.08" rpy="0 0 24"/>
    <parent link="chassis"/>
    <child link="box"/>
    <axis xyz="0 0 1" />
  </joint>

  <link name="laser_sensor"/>

  <joint name='laser_sensor_joint' type='fixed'>
    <origin xyz="0.5 0 0" rpy="0 0 0"/>
    <parent link="chassis"/>
    <child link="laser_sensor"/>
    <axis xyz="0 0 1" />
  </joint>

  <xacro:if value="$(arg sim_gazebo_classic)">
    <gazebo reference="laser_sensor">
      <sensor name="sensor_ray" type="ray">
        <pose>0.5 0 0 0 0 0</pose>
        <ray>
          <scan>
            <horizontal>
              <samples>200</samples>
              <resolution>1.0</resolution>
              <min_angle>-1.0</min_angle>
              <max_angle>1.0</max_angle>
            </horizontal>
          </scan>
          <range>
            <min>0.05</min>
            <max>10.0</max>
          </range>
        </ray>
        <always_on>true</always_on>
        <visualize>true</visualize>
        <update_rate>100.0</update_rate>
        <plugin name="laser" filename="libgazebo_ros_ray_sensor.so">
          <ros>
            <namespace>/dolly</namespace>
            <remapping>~/out:=laser_scan</remapping>
          </ros>
          <output_type>sensor_msgs/LaserScan</output_type>
        </plugin>
      </sensor>
    </gazebo>
  </xacro:if>

  <xacro:if value="$(arg sim_ignition)">
    <gazebo reference="laser_sensor">
      <sensor name="sensor_ray" type="gpu_lidar">
        <pose>0.5 0 0 0 0 0</pose>
        <topic>/dolly/laser_scan</topic>
        <ray>
          <scan>
            <horizontal>
              <samples>200</samples>
              <resolution>1.0</resolution>
              <min_angle>-1.0</min_angle>
              <max_angle>1.0</max_angle>
            </horizontal>
          </scan>
          <range>
            <min>0.05</min>
            <max>10.0</max>
          </range>
        </ray>
        <always_on>true</always_on>
        <visualize>true</visualize>
        <update_rate>100.0</update_rate>
      </sensor>
    </gazebo>
  </xacro:if>


  <link name='caster'>
    <inertial>
      <mass value= "0.0415553"/>
      <inertia ixx="7.97741e-05" ixy="0" ixz="0" iyy="7.97741e-05" iyz="0" izz="7.97741e-05"/>
    </inertial>
    <visual name='visual'>
      <geometry>
        <sphere radius="0.1"/>
      </geometry>
      <material name="caster_material">
        <diffuse>0.5 0.5 0.5 1</diffuse>
        <ambient>0 0 0 1</ambient>
        <specular>1 1 1 1</specular>
        <emissive>0 0 0 1</emissive>
      </material>
    </visual>
    <collision name='collision'>
      <geometry>
        <sphere radius="0.1"/>
      </geometry>
      <surface>
        <friction>
          <ode>
            <mu>1</mu>
            <mu2>1</mu2>
            <slip1>0</slip1>
            <slip2>0</slip2>
          </ode>
        </friction>
        <contact>
          <ode>
            <soft_cfm>0</soft_cfm>
            <soft_erp>0.2</soft_erp>
            <kp>1e+13</kp>
            <kd>1</kd>
            <max_vel>0.01</max_vel>
            <min_depth>0</min_depth>
          </ode>
        </contact>
      </surface>
    </collision>
  </link>

  <link name='left_wheel'>
    <inertial>
      <mass value= "0.5"/>
      <inertia ixx="0.0029" ixy="0" ixz="0" iyy="0.0029" iyz="0" izz="0.0056" />
    </inertial>
    <visual name='visual'>
      <geometry>
        <cylinder radius="0.15" length="0.05"/>
      </geometry>
      <material name="left_wheel_material">
        <diffuse>0.5 0.5 0.5 1</diffuse>
        <ambient>0 0 0 1</ambient>
        <specular>1 1 1 1</specular>
        <emissive>0 0 0 1</emissive>
      </material>
    </visual>
    <collision name='collision'>
      <geometry>
        <cylinder radius="0.15" length="0.05"/>
      </geometry>
      <surface>
        <friction>
          <ode>
            <mu>1</mu>
            <mu2>1</mu2>
            <slip1>0</slip1>
            <slip2>0</slip2>
          </ode>
        </friction>
        <contact>
          <ode>
            <soft_cfm>0</soft_cfm>
            <soft_erp>0.2</soft_erp>
            <kp>1e+13</kp>
            <kd>1</kd>
            <max_vel>0.01</max_vel>
            <min_depth>0.01</min_depth>
          </ode>
        </contact>
      </surface>
    </collision>
  </link>

  <link name='right_wheel'>
    <pose>0.3 -0.3 -0.075 -1.5707 0 0</pose>
    <inertial>
      <mass value= "0.5"/>
      <inertia ixx="0.0029" ixy="0" ixz="0" iyy="0.0029" iyz="0" izz="0.0056" />
    </inertial>
    <visual name='visual'>
      <geometry>
        <cylinder radius="0.15" length="0.05"/>
      </geometry>
      <material name="right_wheel_material">
        <diffuse>0.5 0.5 0.5 1</diffuse>
        <ambient>0 0 0 1</ambient>
        <specular>1 1 1 1</specular>
        <emissive>0 0 0 1</emissive>
      </material>
    </visual>
    <collision name='collision'>
      <geometry>
        <cylinder radius="0.15" length="0.05"/>
      </geometry>
      <surface>
        <friction>
          <ode>
            <mu>1</mu>
            <mu2>1</mu2>
            <slip1>0</slip1>
            <slip2>0</slip2>
          </ode>
        </friction>
        <contact>
          <ode>
            <soft_cfm>0</soft_cfm>
            <soft_erp>0.2</soft_erp>
            <kp>1e+13</kp>
            <kd>1</kd>
            <max_vel>0.01</max_vel>
            <min_depth>0.01</min_depth>
          </ode>
        </contact>
      </surface>
    </collision>
  </link>

  <link name='tail'>
    <inertial>
      <mass value="0.0254232" />
      <inertia ixx="1.528e-05" ixy="0" ixz="0" iyy="1.528e-05" iyz="0" izz="3.45e-06" />
      <pose frame=''>0 0 -0.04 0 -0 0</pose>
    </inertial>
    <visual name='visual'>
      <geometry>
        <cylinder radius="0.016468" length="0.08"/>
      </geometry>
      <material name="tail_material">
        <script>
          <uri>model://dolly/materials/scripts</uri>
          <uri>model://dolly/materials/textures</uri>
          <name>Dolly/fur</name>
        </script>
      </material>
    </visual>
  </link>

  <joint name='left_wheel_joint' type='continuous'>
    <origin xyz="0.3 0.3 -0.075" rpy="-1.5707 0 0"/>
    <parent link="chassis"/>
    <child link="left_wheel"/>
    <limit effort="10" velocity="10"/>
    <joint_properties damping="1.0" friction="1.0"/>
    <axis xyz="0 0 1" />
  </joint>

  <joint name='right_wheel_joint' type='continuous'>
    <origin xyz="0.3 -0.3 -0.075" rpy="-1.5707 0 0"/>
    <parent link="chassis"/>
    <child link="right_wheel"/>
    <limit effort="10" velocity="10"/>
    <joint_properties damping="1.0" friction="1.0"/>
    <axis xyz="0 0 1" />
  </joint>

  <joint name='caster_wheel' type='fixed'>
    <origin xyz="-0.3 0 -0.125" rpy="0 0 0"/>
    <parent link="chassis"/>
    <child link="caster"/>
  </joint>

  <joint name='tail_joint' type='revolute'>
    <parent link="chassis"/>
    <child link="tail"/>
    <origin xyz="-0.52 0 0.04" rpy="-1.6 0 0"/>
    <limit lower="-1.79769e+308" upper="1.79769e+308" effort="-1" velocity="-1" />
    <axis>
      <xyz>1 0 0</xyz>
      <use_parent_model_frame>0</use_parent_model_frame>
      <dynamics>
        <spring_reference>0</spring_reference>
        <spring_stiffness>0</spring_stiffness>
        <damping>0</damping>
        <friction>0</friction>
      </dynamics>
    </axis>
    <physics>
      <ode>
        <limit>
          <cfm>0</cfm>
          <erp>0.2</erp>
        </limit>
        <suspension>
          <cfm>0</cfm>
          <erp>0.2</erp>
        </suspension>
      </ode>
    </physics>
  </joint>


  <xacro:if value="$(arg sim_gazebo_classic)">
    <gazebo>
      <plugin name='diff_drive' filename='libgazebo_ros_diff_drive.so'>

        <ros>
          <namespace>/dolly</namespace>
        </ros>

        <!-- wheels -->
        <left_joint>left_wheel_joint</left_joint>
        <right_joint>right_wheel_joint</right_joint>

        <!-- kinematics -->
        <wheel_separation>1.25</wheel_separation>
        <wheel_diameter>0.3</wheel_diameter>

        <!-- limits -->
        <max_wheel_torque>20</max_wheel_torque>
        <max_wheel_acceleration>1.0</max_wheel_acceleration>

        <!-- output -->
        <publish_odom>true</publish_odom>
        <publish_odom_tf>true</publish_odom_tf>

        <odometry_frame>odom_demo</odometry_frame>
        <robot_base_frame>chassis</robot_base_frame>

      </plugin>
    </gazebo>
  </xacro:if>

  <xacro:if value="$(arg sim_ignition)">
    <gazebo>
      <plugin
        filename="ignition-gazebo-diff-drive-system"
        name="ignition::gazebo::systems::DiffDrive">

        <!-- wheels -->
        <left_joint>left_wheel_joint</left_joint>
        <right_joint>right_wheel_joint</right_joint>

        <!-- kinematics -->
        <wheel_separation>1.25</wheel_separation>
        <wheel_radius>0.3</wheel_radius>
        <topic>/dolly/cmd_vel</topic>
        <odom_topic>/dolly/odometry</odom_topic>
      </plugin>
    </gazebo>
  </xacro:if>

  <gazebo reference="chassis">
    <material>
      <script>
        <uri>model://dolly/materials/scripts</uri>
        <uri>model://dolly/materials/textures</uri>
        <name>aruco_tag_0</name>
      </script>
    </material>
  </gazebo>


</robot>
